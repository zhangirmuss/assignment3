<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>FitTrack - Single Page</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    nav .link { cursor:pointer; margin-right:12px; color:var(--accent2); }
    .hidden { display:none; }
    .form-row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    input, textarea, select { padding:8px; border-radius:6px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:inherit; }
    .table{ width:100%; border-collapse:collapse; }
    .table th,.table td{ padding:8px; border-bottom:1px solid rgba(255,255,255,0.04); }
    .muted { opacity:0.7; }
    .card { background:rgba(255,255,255,0.03); padding:14px; border-radius:12px; }
    .card img { width:100%; border-radius:10px; display:block; }
  </style>
</head>
<body>
  <header class="container">
    <h1>FitTrack</h1>
    <p class="tagline">Single-page demo for CRUD, auth and sessions</p>
    <nav class="nav" id="main-nav">
      <span class="link" data-target="home">Home</span>
      <span class="link" data-target="search">Search</span>
      <span class="link" data-target="contact">Contact</span>
      <span class="link" data-target="items">Items</span>
      <span class="link" data-target="dashboard">Dashboard</span>
      <span class="link" data-target="info">Info</span>
      <span class="link" data-target="stats">Stats</span>

      <span style="float:right" id="auth-links">
        <span class="link" data-target="login">Login</span>
        <span class="link" data-target="register">Register</span>
      </span>
    </nav>
  </header>

  <main class="container content">

    <section id="home-section">
      <h2>Welcome to FitTrack (SPA)</h2>
      <p>Use the nav above to test CRUD, authentication (sessions), and API features.</p>
      <p class="muted">Rule: anyone can read (GET), but create/update/delete requires login.</p>

      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;margin-top:16px;">
        <div class="card">
          <img src="https://picsum.photos/seed/fittrack1/600/350" alt="workout">
          <h3 style="margin-top:10px;">Track workouts</h3>
          <p class="muted">Create and manage exercises in the dashboard.</p>
        </div>

        <div class="card">
          <img src="https://picsum.photos/seed/fittrack2/600/350" alt="gym">
          <h3 style="margin-top:10px;">Session login</h3>
          <p class="muted">CRUD is protected: only logged-in users can modify data.</p>
        </div>

        <div class="card">
          <img src="https://picsum.photos/seed/fittrack3/600/350" alt="health">
          <h3 style="margin-top:10px;">Contact me</h3>
          <p class="muted">Send email + phone + message to the server.</p>
        </div>
      </div>
    </section>

    <section id="search-section" class="hidden">
      <h2>Search Exercises</h2>
      <div class="form-row" style="margin-bottom:12px;">
        <input id="search-q-main" placeholder="Search by title or muscle" style="flex:1">
        <button id="search-btn">Search</button>
      </div>
      <div id="search-results" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px"></div>
    </section>

    <section id="items-section" class="hidden">
      <h2>Exercises (public)</h2>
      <p>This catalog is read-only for anonymous users; create/edit/delete require login.</p>
      <table class="table">
        <thead>
          <tr><th>Id</th><th>Title</th><th>Muscle</th><th>Duration</th><th>Actions</th></tr>
        </thead>
        <tbody id="items-table-body">
          <tr><td colspan="5" class="muted">Loading...</td></tr>
        </tbody>
      </table>
    </section>

    <section id="dashboard-section" class="hidden">
      <h2>Dashboard (CRUD)</h2>
      <p>Create / Edit / Delete (requires login)</p>

      <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">
        <input id="dash-q" placeholder="Search">
        <select id="dash-sort">
          <option value="">Sort none</option>
          <option value="title:asc">Title ↑</option>
          <option value="title:desc">Title ↓</option>
          <option value="durationMinutes:asc">Duration ↑</option>
          <option value="durationMinutes:desc">Duration ↓</option>
        </select>
        <button id="dash-apply">Apply</button>
      </div>

      <form id="dash-create" style="margin-bottom:12px">
        <div class="form-row">
          <input id="c-title" placeholder="Title" required>
          <input id="c-desc" placeholder="Description" required>
          <input id="c-muscle" placeholder="Muscle">
          <input id="c-difficulty" placeholder="Difficulty">
          <input id="c-duration" type="number" placeholder="Duration" style="width:100px">
          <button type="submit">Create</button>
        </div>
      </form>

      <table class="table">
        <thead>
          <tr><th>Id</th><th>Title</th><th>Description</th><th>Muscle</th><th>Difficulty</th><th>Duration</th><th>Actions</th></tr>
        </thead>
        <tbody id="dash-body">
          <tr><td colspan="7" class="muted">Loading...</td></tr>
        </tbody>
      </table>

      <h3>Edit</h3>
      <form id="dash-edit">
        <input id="e-id" type="hidden">
        <div class="form-row" style="margin-top:8px">
          <input id="e-title" placeholder="Title" required>
          <input id="e-desc" placeholder="Description" required>
          <input id="e-muscle" placeholder="Muscle">
          <input id="e-difficulty" placeholder="Difficulty">
          <input id="e-duration" type="number" placeholder="Duration" style="width:100px">
          <button type="submit">Update</button>
        </div>
      </form>
    </section>

    <section id="login-section" class="hidden">
      <h2>Login</h2>
      <form id="login-form-main">
        <label>Username<br><input id="login-user" required></label><br><br>
        <label>Password<br><input id="login-pass" type="password" required></label><br><br>
        <button type="submit">Login</button>
      </form>
      <p class="muted">Tip: admin / adminpass</p>
    </section>

    <section id="register-section" class="hidden">
      <h2>Register</h2>
      <form id="reg-form-main">
        <label>Username<br><input id="reg-user" required></label><br><br>
        <label>Password<br><input id="reg-pass" type="password" required></label><br><br>
        <button type="submit">Register</button>
      </form>
    </section>

    <section id="contact-section-spa" class="hidden">
      <h2>Contact me</h2>
      <p class="muted">Leave your email, phone and message — it will be saved on the server.</p>

      <form id="contact-form-main">
        <label>Name<br><input name="name" required></label><br><br>
        <label>Email<br><input name="email" type="email" required></label><br><br>
        <label>Phone<br><input name="phone" placeholder="+7 (___) ___-__-__"></label><br><br>
        <label>Message<br><textarea name="message" rows="4" required></textarea></label><br><br>
        <button type="submit">Send</button>
      </form>
    </section>

    <section id="info-section" class="hidden">
      <h2>API Info</h2>
      <pre id="api-info">Loading...</pre>
    </section>

    <section id="stats-section" class="hidden">
      <h2>API Stats</h2>
      <ul id="api-stats-list"><li>Loading...</li></ul>
    </section>

  </main>

  <script>
    // -------- SPA navigation --------
    const sections = {
      home: document.getElementById('home-section'),
      search: document.getElementById('search-section'),
      items: document.getElementById('items-section'),
      dashboard: document.getElementById('dashboard-section'),
      login: document.getElementById('login-section'),
      register: document.getElementById('register-section'),
      contact: document.getElementById('contact-section-spa'),
      info: document.getElementById('info-section'),
      stats: document.getElementById('stats-section')
    };

    function showSection(name){
      Object.values(sections).forEach(s=>s.classList.add('hidden'));
      const s = sections[name] || sections.home;
      s.classList.remove('hidden');

      if(name === 'items') loadItemsPublic();
      if(name === 'dashboard') loadDashboard();
      if(name === 'search') document.getElementById('search-q-main').focus();
      if(name === 'info') loadInfo();
      if(name === 'stats') loadStats();

      updateAuthLinks();
    }

    document.getElementById('main-nav').addEventListener('click', (e)=>{
      const t = e.target.getAttribute('data-target');
      if(t) showSection(t);
    });

    // -------- helpers --------
    async function apiFetchJson(url, options){
      const res = await fetch(url, options);
      if(res.status === 401) {
        alert('Unauthorized: please login first');
        showSection('login');
        throw new Error('Unauthorized');
      }
      if(!res.ok){
        const txt = await res.text();
        throw new Error(txt || res.statusText);
      }
      return await res.json();
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>'\"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;'})[c]||c);
    }

    // -------- Auth UI --------
    async function updateAuthLinks(){
      try{
        const res = await fetch('/auth/me');
        if(!res.ok) throw new Error('no');
        const j = await res.json();

        if(j.user){
          document.getElementById('auth-links').innerHTML =
            `<span>Hi ${escapeHtml(j.user.username)}</span> <span class="link" id="logout-link">Logout</span>`;
          document.getElementById('logout-link').addEventListener('click', async ()=>{
            await fetch('/auth/logout', { method:'POST' });
            await updateAuthLinks();
            showSection('home');
          });
        } else {
          document.getElementById('auth-links').innerHTML =
            `<span class="link" data-target="login">Login</span> <span class="link" data-target="register">Register</span>`;
        }
      } catch(e){
        document.getElementById('auth-links').innerHTML =
          `<span class="link" data-target="login">Login</span> <span class="link" data-target="register">Register</span>`;
      }
    }

    document.getElementById('login-form-main').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const username = document.getElementById('login-user').value.trim();
      const password = document.getElementById('login-pass').value.trim();

      try{
        const res = await fetch('/auth/login', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await res.json().catch(()=>({}));
        if(res.ok && data.success){
          await updateAuthLinks();
          showSection('dashboard');
        } else {
          alert(data.error || 'Invalid credentials');
        }
      } catch(err){
        alert('Login error');
      }
    });

    document.getElementById('reg-form-main').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const username = document.getElementById('reg-user').value.trim();
      const password = document.getElementById('reg-pass').value.trim();

      try{
        const res = await fetch('/auth/register', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await res.json().catch(()=>({}));
        if(res.ok && data.success){
          await updateAuthLinks();
          showSection('dashboard');
        } else {
          alert(data.error || 'Registration failed');
        }
      } catch(err){
        alert('Register error');
      }
    });

    // -------- Public items list (GET allowed) --------
    async function loadItemsPublic(){
      const tbody = document.getElementById('items-table-body');
      try{
        const items = await apiFetchJson('/api/items');
        if(!items.length){
          tbody.innerHTML = '<tr><td colspan="5" class="muted">No items</td></tr>';
          return;
        }
        tbody.innerHTML = '';
        items.forEach(it=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${it.id}</td><td>${escapeHtml(it.title)}</td><td>${escapeHtml(it.muscle||'')}</td><td>${escapeHtml(it.durationMinutes||'')}</td><td><button data-id="${it.id}" class="view-item">Open</button></td>`;
          tbody.appendChild(tr);
        });
      } catch(e){
        tbody.innerHTML = '<tr><td colspan="5" class="muted">Failed to load</td></tr>';
      }
    }

    // -------- Dashboard CRUD --------
    async function loadDashboard(){
      const body = document.getElementById('dash-body');
      const q = (document.getElementById('dash-q')||{}).value||'';
      const sortBy = (document.getElementById('dash-sort')||{}).value||'';

      try{
        let items = await apiFetchJson('/api/items');

        if(q){
          const qq = q.toLowerCase();
          items = items.filter(x =>
            (x.title||'').toLowerCase().includes(qq) ||
            (x.muscle||'').toLowerCase().includes(qq)
          );
        }

        if(sortBy){
          const [field, dir] = sortBy.split(':');
          items.sort((a,b)=>{
            const av = a[field] ?? '';
            const bv = b[field] ?? '';
            if(typeof av === 'number' && typeof bv === 'number'){
              return dir === 'asc' ? av - bv : bv - av;
            }
            return dir === 'asc'
              ? String(av).localeCompare(String(bv))
              : String(bv).localeCompare(String(av));
          });
        }

        if(!items.length){
          body.innerHTML = '<tr><td colspan="7" class="muted">No items</td></tr>';
          return;
        }

        body.innerHTML = '';
        items.forEach(it=>{
          const tr = document.createElement('tr');
          tr.innerHTML =
            `<td>${it.id}</td>
             <td>${escapeHtml(it.title)}</td>
             <td>${escapeHtml(it.description||'')}</td>
             <td>${escapeHtml(it.muscle||'')}</td>
             <td>${escapeHtml(it.difficulty||'')}</td>
             <td>${escapeHtml(it.durationMinutes||'')}</td>
             <td>
               <button class="edit-btn" data-id="${it.id}">Edit</button>
               <button class="del-btn" data-id="${it.id}">Delete</button>
             </td>`;
          body.appendChild(tr);
        });
      } catch(e){
        body.innerHTML = '<tr><td colspan="7" class="muted">Failed to load</td></tr>';
      }
    }

    document.getElementById('dash-apply').addEventListener('click', ()=> loadDashboard());

    document.getElementById('dash-create').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const title = document.getElementById('c-title').value.trim();
      const description = document.getElementById('c-desc').value.trim();
      const muscle = document.getElementById('c-muscle').value.trim();
      const difficulty = document.getElementById('c-difficulty').value.trim();
      const duration = Number(document.getElementById('c-duration').value||0);

      if(!title || !description){
        alert('Title and description required');
        return;
      }

      try{
        await apiFetchJson('/api/items', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ title, description, muscle, difficulty, durationMinutes: duration })
        });

        document.getElementById('c-title').value='';
        document.getElementById('c-desc').value='';
        document.getElementById('c-muscle').value='';
        document.getElementById('c-difficulty').value='';
        document.getElementById('c-duration').value='';
        loadDashboard();
      } catch(err){
        if(String(err.message).includes('Unauthorized')) {
          alert('Unauthorized: please login first');
          showSection('login');
        } else {
          alert('Create failed: ' + err.message);
        }
      }
    });

    document.getElementById('dash-body').addEventListener('click', async (e)=>{
      const id = e.target.getAttribute('data-id');

      if(e.target.classList.contains('del-btn')){
        if(!confirm('Delete?')) return;
        try{
          await apiFetchJson(`/api/items/${id}`, { method:'DELETE' });
          loadDashboard();
        } catch(err){
          if(String(err.message).includes('Unauthorized')) {
            alert('Unauthorized: please login first');
            showSection('login');
          } else {
            alert('Delete failed: ' + err.message);
          }
        }
      }

      if(e.target.classList.contains('edit-btn')){
        try{
          const item = await apiFetchJson(`/api/items/${id}`);
          document.getElementById('e-id').value = item.id;
          document.getElementById('e-title').value = item.title;
          document.getElementById('e-desc').value = item.description || '';
          document.getElementById('e-muscle').value = item.muscle || '';
          document.getElementById('e-difficulty').value = item.difficulty || '';
          document.getElementById('e-duration').value = item.durationMinutes || '';
          window.scrollTo(0,0);
        } catch(err){
          alert('Load failed');
        }
      }
    });

    document.getElementById('dash-edit').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const id = document.getElementById('e-id').value;
      const title = document.getElementById('e-title').value.trim();
      const description = document.getElementById('e-desc').value.trim();
      const muscle = document.getElementById('e-muscle').value.trim();
      const difficulty = document.getElementById('e-difficulty').value.trim();
      const duration = Number(document.getElementById('e-duration').value||0);

      if(!id || !title || !description){
        alert('Title and description required');
        return;
      }

      try{
        await apiFetchJson(`/api/items/${id}`, {
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ title, description, muscle, difficulty, durationMinutes: duration })
        });

        document.getElementById('e-id').value='';
        document.getElementById('e-title').value='';
        document.getElementById('e-desc').value='';
        document.getElementById('e-muscle').value='';
        document.getElementById('e-difficulty').value='';
        document.getElementById('e-duration').value='';
        loadDashboard();
      } catch(err){
        if(String(err.message).includes('Unauthorized')) {
          alert('Unauthorized: please login first');
          showSection('login');
        } else {
          alert('Update failed: ' + err.message);
        }
      }
    });

    // -------- Search --------
    document.getElementById('search-btn').addEventListener('click', async ()=>{
      const q = document.getElementById('search-q-main').value.trim().toLowerCase();
      const grid = document.getElementById('search-results');
      grid.innerHTML='';

      try{
        const all = await apiFetchJson('/api/items');
        const list = q
          ? all.filter(x => (x.title||'').toLowerCase().includes(q) || (x.muscle||'').toLowerCase().includes(q))
          : all;

        if(!list.length){
          grid.innerHTML = '<p class="muted">No results</p>';
          return;
        }

        list.forEach(e=>{
          const d = document.createElement('div');
          d.className='exercise-card';
          d.style='background:rgba(255,255,255,0.02);padding:12px;border-radius:8px;';
          d.innerHTML = `<h3>${escapeHtml(e.title)}</h3>
                         <p>${escapeHtml(e.description||'')}</p>
                         <p><strong>Muscle:</strong> ${escapeHtml(e.muscle||'')}</p>`;
          grid.appendChild(d);
        });
      } catch(err){
        grid.innerHTML='<p class="muted">Failed to load</p>';
      }
    });

    // -------- Contact --------
    document.getElementById('contact-form-main').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const f = e.target;
      const data = {
        name: f.name.value.trim(),
        email: f.email.value.trim(),
        phone: (f.phone?.value || '').trim(),
        message: f.message.value.trim()
      };

      if(!data.name || !data.email || !data.message){
        alert('Missing fields');
        return;
      }

      try{
        const res = await fetch('/contact', {
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded'},
          body: new URLSearchParams(data)
        });

        if(res.ok){
          alert('Message sent');
          showSection('home');
        } else {
          alert('Send failed');
        }
      } catch(err){
        alert('Send error');
      }
    });

    // -------- info/stats --------
    async function loadInfo(){
      try{
        const j = await apiFetchJson('/api/info');
        document.getElementById('api-info').textContent = JSON.stringify(j,null,2);
      }catch(e){
        document.getElementById('api-info').textContent = 'Failed';
      }
    }
    async function loadStats(){
      try{
        const j = await apiFetchJson('/api/stats');
        document.getElementById('api-stats-list').innerHTML =
          `<li>Items: ${j.itemsCount}</li><li>Contacts: ${j.contactsCount}</li><li>Uptime (s): ${j.uptimeSeconds}</li>`;
      }catch(e){
        document.getElementById('api-stats-list').innerHTML = '<li>Failed</li>';
      }
    }

    // start
    showSection('home');
    updateAuthLinks();
  </script>
</body>
</html>


